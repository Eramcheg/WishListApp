{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Wishlist{% endblock %}</title>

  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="{% static 'icons/favicon.ico' %}">
  {% block extra_meta %}{% endblock %}
</head>

<body class="bg-bg text-text min-h-screen">
    <!-- NAVBAR -->
    <nav class="bg-accent text-white shadow mb-6">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <a href="/" class="font-bold text-xl hover:opacity-90">üéÅ WishList</a>
          <div class="flex items-center gap-6">
            {% if user.is_authenticated %}
              <a href="{% url 'public_profile' user.username %}" class="opacity-90 flex items-end gap-1">
                  <div class="h-7 w-7 rounded-full border bg-muted overflow-hidden flex items-center justify-center text-sm">
                    {% if request.user.profile.avatar %}
                      <img src="{{ wishlist.owner.profile.avatar.url }}" class="h-full w-full object-cover">
                    {% else %}
                      {{ request.user.username|first|upper }}
                    {% endif %}
                  </div>
                  {{ user.profile.display_name|default:user.username }}
              </a>
            {% else %}
              <a href="{% url 'login' %}" class="hover:opacity-90 mr-2">Login</a>
              <a href="{% url 'register' %}"
                 class="bg-white text-accent px-3 py-1 rounded font-medium hover:opacity-90 transition">
                Sign up
              </a>
            {% endif %}
          </div>
        </div>
    </nav>

  {% block body %}
    <main class="max-w-7xl mx-auto px-4">
{#        <div class=" mx-auto px-4 py-6">#}
          {% block content %}{% endblock %}
{#        </div>#}
    </main>
  {% endblock %}


    {% include "partials/sidebar.html" %}
    <div id="toast-root" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

</body>
<script src="{% static 'js/partials/icon_picker.js' %}"></script>
<script>
    lucide.createIcons();
    (function () {
      const root = document.getElementById('toast-root');

      function iconFor(type) {
        const map = { info:'info', success:'check-circle', error:'alert-triangle' };
        return map[type] || 'info';
      }
      document.querySelectorAll('[data-truncate]').forEach(el => {
        // 1) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
        const lines = parseInt(el.dataset.lines || '2', 10);
        el.classList.add('truncate-box');
        el.style.setProperty('--lines', lines);

        // 2) –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∫–Ω–æ–ø–∫—É –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
        // –ù–µ–±–æ–ª—å—à–æ–π setTimeout, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —É—Å–ø–µ–ª –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —à—Ä–∏—Ñ—Ç–æ–≤
        setTimeout(() => {
          const isOverflowing = el.scrollHeight > el.clientHeight + 1;
          if (!isOverflowing) return;

          // 3) –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫—É
          const btn = document.createElement('button');
          btn.type = 'button';
          // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ Tailwind-–∫–ª–∞—Å—Å—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          btn.className = 'truncate-toggle';
          const more = el.dataset.more || '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë';
          const less = el.dataset.less || '–°–≤–µ—Ä–Ω—É—Ç—å';
          btn.textContent = more;
          btn.setAttribute('aria-expanded', 'false');

          // 4) –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
          btn.addEventListener('click', () => {
            const expanded = el.classList.toggle('is-expanded');
            btn.textContent = expanded ? less : more;
            btn.setAttribute('aria-expanded', String(expanded));
          });

          // 5) –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç–ª–µ–º–µ–Ω—Ç–∞
          el.insertAdjacentElement('afterend', btn);
        }, 0);
      });
      // –°–æ–∑–¥–∞–Ω–∏–µ DOM —Ç–æ—Å—Ç–∞
      function createToast({ type='info', title='', message='', duration=6000 }) {
        const el = document.createElement('div');
        el.className = `toast toast--${type} toast-enter`;
        el.setAttribute('role', type === 'error' ? 'alert' : 'status');
        el.style.setProperty('--toast-duration', `${duration}ms`);

        el.innerHTML = `
          <div class="toast-progress"></div>
          <div class="toast-row">
            <span class="toast-icon"><i data-lucide="${iconFor(type)}" class="w-5 h-5"></i></span>
            <div class="min-w-0">
              ${title ? `<div class="toast-title">${title}</div>` : ``}
              ${message ? `<div class="toast-desc">${message}</div>` : ``}
            </div>
            <button class="toast-close" aria-label="Close" type="button">&times;</button>
          </div>
        `;

        root.appendChild(el);
        requestAnimationFrame(() => {
          el.classList.add('toast-enter-active');
          setTimeout(() => el.classList.remove('toast-enter','toast-enter-active'), 220);
        });

        el.querySelector('.toast-close').addEventListener('click', () => closeToast(el));
        let remaining = duration, started = Date.now(), timer;
        const progress = el.querySelector('.toast-progress');

        function startTimer() {
          started = Date.now();
          progress.style.animationPlayState = 'running';
          timer = setTimeout(() => closeToast(el), remaining);
        }
        function pauseTimer() {
          clearTimeout(timer);
          const elapsed = Date.now() - started;
          remaining = Math.max(0, remaining - elapsed);
          progress.style.animationPlayState = 'paused';
        }

        el.addEventListener('mouseenter', pauseTimer);
        el.addEventListener('mouseleave', () => {
          if (remaining > 0) startTimer();
        });

        startTimer();
        if (window.lucide) { window.lucide.createIcons({ icons: window.lucide.icons, attrs: {}}); }
        return el;
      }

      function closeToast(el) {
        el.classList.add('toast-leave');
        setTimeout(() => { el.remove(); }, 220);
      }

      window.addToast = function({ type='info', title='', message='', duration=6000 } = {}) {
        return createToast({ type, title, message, duration });
      };
      window.toast = {
        info:    (msg, t='Info', d=6000) => addToast({ type:'info',    title:t, message:msg, duration:d }),
        success: (msg, t='Success', d=4000) => addToast({ type:'success', title:t, message:msg, duration:d }),
        error:   (msg, t='Error', d=7000) => addToast({ type:'error',   title:t, message:msg, duration:d }),
      };
    })();

</script>
{% if messages %}
    <script>
      (function () {
        {% for message in messages %}
          addToast({
            type: "{% if 'error' in message.tags %}error{% else %}info{% endif %}",
            title: "{% if 'error' in message.tags %}Error{% else %}Info{% endif %}",
            message: "{{ message|escapejs }}",
            duration: {% if 'error' in message.tags %}7000{% else %}5000{% endif %}
          });
        {% endfor %}
      })();
    </script>
{% endif %}
{% block extra_js %}

{% endblock %}
</html>
