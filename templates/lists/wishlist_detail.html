{% extends "base.html" %}
{% load query %}
{% block title %}
  {% if object.owner_id != request.user.id %}
    {{ object.owner }}'s wishlist "{{ object.title }}"
  {% else %}
    {{ object.title }}
  {% endif %}
{% endblock %}
{% block content %}
    <header class="space-y-2 mb-6">
  <h1 class="text-2xl font-semibold tracking-tight">
    {{ wishlist.title }}
  </h1>

  {% if wishlist.description %}
    <p class="text-sm text-muted-foreground">
      {{ wishlist.description }}
    </p>
  {% endif %}

  <div class="mt-3">
    {% include "partials/profile_chip.html" with user=wishlist.owner profile=wishlist.owner.profile %}
  </div>
</header>
    <div class="mb-6 flex items-start justify-between gap-3">
      <div>
        <h2 class="text-2xl font-bold">
          {% if object.owner_id != request.user.id %}
            {{ object.owner }}'s wishlist "{{ object.title }}"
          {% else %}
            {{ object.title }}
          {% endif %}
        </h2>
        {% if object.description %}
          <p class="mt-1 text-muted">{{ object.description }}</p>
        {% endif %}
      </div>

      <div class="flex items-center gap-2">
        <a href="{% url 'wishlist_list' %}" class="btn btn-muted btn-sm">Back</a>

        <!-- Primary CTA -->
        <a href="{% url 'item_create' object.slug %}" class="btn btn-primary btn-sm">+ New item</a>

        {% if object.owner_id == request.user.id %}
          <!-- Compact “More” menu (no JS needed) -->
          <details class="relative" id="more-menu">
            <summary class="btn btn-secondary btn-sm cursor-pointer select-none">More</summary>
            <div class="absolute right-0 mt-2 w-56 rounded-md border border-border bg-white shadow-lg z-10 p-1">
              <a href="{% url 'wishlist_edit' object.slug %}" class="block px-3 py-2 rounded hover:bg-border/80">Edit wishlist</a>
              <a href="{% url 'items_bulk_add' object.slug %}" class="block px-3 py-2 rounded hover:bg-border/80">Add multiple</a>
              <a href="{% url 'items_import' object.slug %}" class="block px-3 py-2 rounded hover:bg-border/80">Import</a>
              <a href="{% url 'wishlist_access' object.slug %}" class="block px-3 py-2 rounded hover:bg-border/80">Co-authors</a>
              {% if object.is_public %}
                <a href="{% url 'public_wl_detail' object.slug %}" class="block px-3 py-2 rounded hover:bg-border/80">Open public link</a>
              {% endif %}
              <div class="my-1 border-t border-border/60"></div>
              <a href="{% url 'wishlist_delete' object.slug %}" class="block px-3 py-2 rounded text-error hover:bg-error/10">Delete</a>
            </div>
          </details>

        {% endif %}
      </div>
    </div>

    {% if object.owner_id == request.user.id %}
      <!-- Share panel -->
      <div class="mb-6 rounded-md border border-border bg-bg-secondary p-3 space-y-2">
        {% if object.share_token %}
          <p class="text-sm">Anyone with this link can view your wishlist:</p>
          <div class="flex items-center gap-2">
            <input class="inp text-sm" readonly
                   value="{{ request.scheme }}://{{ request.get_host }}{% url 'wishlist_sharelink' object.share_token %}" id="share-url">
            <button type="button" class="btn btn-secondary btn-sm" onclick="
              navigator.clipboard.writeText(document.getElementById('share-url').value)
            ">Copy</button>
          </div>
          <form method="post" action="{% url 'wishlist_share' object.slug %}">
            {% csrf_token %}
            <button name="revoke" value="1" class="btn btn-danger btn-sm mt-2">Revoke link</button>
          </form>
        {% else %}
          <form method="post" action="{% url 'wishlist_share' object.slug %}" class="flex items-center gap-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary btn-sm">Generate share link</button>
          </form>
        {% endif %}
      </div>
    {% endif %}
    <h3 class="text-xl font-semibold">Items</h3>
    {% include "partials/pagination.html" %}
    <ul class="grid gap-3 sm:grid-cols-2 lg:grid-cols-2 mb-1">
        {% for item in object_list %}
            {% if item.created_by == request.user or request.user.id == object.owner_id %}
                {% url 'item_edit' wishlist_slug=object.slug item_slug=item.slug as edit_url %}
                {% url 'item_delete' wishlist_slug=object.slug item_slug=item.slug as delete_url %}
                {% with action_html='<a href="'|add:edit_url|add:'" class="btn btn-secondary btn-xsm">Edit</a> <a href="'|add:delete_url|add:'" class="btn btn-danger btn-xsm">Delete</a>'%}
                    <li>
                      {% include "partials/card_tile.html" with href=item.url image_url=item.image_url title=item.title subtitle=item.note actions=action_html to_trunk=True%}
                    </li>
                {% endwith %}
            {% else %}
                <li>
                  {% include "partials/card_tile.html" with href=item.url image_url=item.image_url title=item.title subtitle=item.note to_trunk=True%}
                </li>
            {% endif %}
        {% empty %}
            {% include "partials/empty_state.html" with page_type='edit_page' %}
        {% endfor %}
    </ul>
    {% include "partials/pagination.html" %}
    <script>
        document.addEventListener('click', e => {
        const menu = document.getElementById('more-menu');
        if (!menu) return;
        const summary = menu.querySelector('summary');
        // if clicked outside both the summary and its content → close
        if (menu.open && !menu.contains(e.target) && e.target !== summary) {
          menu.removeAttribute('open');
        }
        });
    </script>
{% endblock %}